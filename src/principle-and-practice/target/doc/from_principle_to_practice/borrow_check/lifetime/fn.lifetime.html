<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="生命周期参数"><meta name="keywords" content="rust, rustlang, rust-lang, lifetime"><title>lifetime in from_principle_to_practice::borrow_check::lifetime - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-1d6438e53893d4f5.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../../../static.files/light-b8db113b98e15459.css"><link rel="stylesheet" disabled href="../../../static.files/dark-4b64df8497ac42b0.css"><link rel="stylesheet" disabled href="../../../static.files/ayu-4939169e939b96f8.css"><script id="default-settings" ></script><script src="../../../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-8f89a77f33748381.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../from_principle_to_practice/index.html"><div class="logo-container"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../from_principle_to_practice/index.html"><div class="logo-container"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><div class="sidebar-elems"><h2><a href="index.html">In from_principle_to_practice::borrow_check::lifetime</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Function <a href="../../index.html">from_principle_to_practice</a>::<wbr><a href="../index.html">borrow_check</a>::<wbr><a href="index.html">lifetime</a>::<wbr><a class="fn" href="#">lifetime</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/from_principle_to_practice/borrow_check/lifetime.rs.html#391">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><div class="item-decl"><pre class="rust fn"><code>pub fn lifetime()</code></pre></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h5 id="生命周期参数"><a href="#生命周期参数">生命周期参数</a></h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// 示例 1: 声明和使用
   </span><span class="kw">fn </span>return_str&lt;<span class="lifetime">&#39;a</span>&gt;() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>str {
       <span class="kw">let </span><span class="kw-2">mut </span>s = <span class="string">&quot;Rust&quot;</span>.to_string();

       <span class="kw">for </span>i <span class="kw">in </span><span class="number">0</span>..<span class="number">3 </span>{
           s.push_str(<span class="string">&quot;Good &quot;</span>);
       }

       <span class="comment">//    &amp;s[..] // 不能返回局部变量，会造成悬垂指针
       </span><span class="string">&quot;hello&quot;
   </span>}

   <span class="kw">let </span>x = return_str();</code></pre><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0A%2F%2F%20%E7%A4%BA%E4%BE%8B%201%3A%20%E5%A3%B0%E6%98%8E%E5%92%8C%E4%BD%BF%E7%94%A8%0Afn%20main()%20%7B%0Afn%20return_str%3C'a%3E()%20-%3E%20%26'a%20str%20%7B%0A%20%20%20%20%20%20%20let%20mut%20s%20%3D%20%22Rust%22.to_string()%3B%0A%0A%20%20%20%20%20%20%20for%20i%20in%200..3%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20s.push_str(%22Good%20%22)%3B%0A%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%2F%2F%20%20%20%20%26s%5B..%5D%20%2F%2F%20%E4%B8%8D%E8%83%BD%E8%BF%94%E5%9B%9E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BC%9A%E9%80%A0%E6%88%90%E6%82%AC%E5%9E%82%E6%8C%87%E9%92%88%0A%20%20%20%20%20%20%20%22hello%22%0A%20%20%20%7D%0A%0A%20%20%20let%20x%20%3D%20return_str()%3B%0A%7D&amp;edition=2021">Run</a></div>
<h5 id="早限定与晚限定"><a href="#早限定与晚限定">早限定与晚限定</a></h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code>    <span class="comment">// 示例 2 生命周期参数的之间的关系

    // 当多个参数都是借用类型，需要指定这些参数生命周期参数之间的关系
    // 指定规则:入参声明周期 &gt;= 返回值生命周期
    // &#39;a: &#39;c 代表 &#39;a &gt; &#39;c

    </span><span class="kw">fn </span>the_longest&lt;<span class="lifetime">&#39;c</span>, <span class="lifetime">&#39;a</span>: <span class="lifetime">&#39;c</span>&gt;(s1: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>str, s2: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>str) -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;c </span>str {
        <span class="kw">if </span>s1.len() &gt; s2.len() {
            s1
        } <span class="kw">else </span>{
            s2
        }
    }

    <span class="kw">let </span>s1 = String::from(<span class="string">&quot;rust&quot;</span>);
    <span class="kw">let </span>s1_r = <span class="kw-2">&amp;</span>s1;
    {
        <span class="kw">let </span>s2 = String::from(<span class="string">&quot;c&quot;</span>);
        <span class="kw">let </span>res = the_longest(s1_r, <span class="kw-2">&amp;</span>s2);
        <span class="macro">println!</span>(<span class="string">&quot;{:?}&quot;</span>, res);
    }

    <span class="comment">// 示例 3 Rust如何识别并判断生命周期参数的？

    // Rust 实际上使用两套规则：early bound 和 late bound
    // 核心是匹配参数和指定的生命周期参数

    // 示例 4 early bound 和 late bound

    // 先看看泛型案例
    </span><span class="kw">struct </span>A&lt;T&gt;(T);

    <span class="comment">// 定义时不指定类型，实际使用时再指定
    </span><span class="kw">let </span>a = A::&lt;i32&gt;(<span class="number">3</span>);
    <span class="kw">let </span>b = A(<span class="string">&quot;string&quot;</span>);


    <span class="comment">// early bound 和 late bound 区别

    </span><span class="kw">fn </span>f&lt;<span class="lifetime">&#39;a</span>&gt;() {} <span class="comment">// late bound,只声明，不指定。
    </span><span class="kw">fn </span>g&lt;<span class="lifetime">&#39;a</span>: <span class="lifetime">&#39;a</span>&gt;() {} <span class="comment">// early bound，声明且指定
    </span><span class="kw">fn </span>h&lt;T&gt;() {}

    <span class="comment">//let pf = f::&lt;&#39;static&gt; as fn(); // late bound 不能手动指定，编译器会自动生成具体的生命周期参数实例
    </span><span class="kw">let </span>pf = f(); <span class="comment">// late bound 直接使用，不用指定

    // 声明周期参数实际上是泛型的一种
    </span><span class="kw">let </span>ph = h::&lt;i32&gt;(); <span class="comment">// 普通泛型可以指定，会在编译期单态化
    </span><span class="kw">let </span>pg = g::&lt;<span class="lifetime">&#39;static</span>&gt; <span class="kw">as fn</span>(); <span class="comment">// early bound 可以具体再指定

    // 案例 4.1 late bound

    </span><span class="kw">struct </span>Buffer {
        buf: Vec&lt;u8&gt;,
        pos: usize,
    }

    <span class="comment">// 没有在实现方法时指定在impl处
    // 导致的结果时在调用函数时，编译器会检查local 变量
    // 但是使用early bound，编译器只会检查参数类型是否正确以及和生命周期是否匹配

    </span><span class="kw">impl </span>Buffer {
        <span class="kw">fn </span>new() -&gt; Buffer {
            Buffer {
                buf: <span class="macro">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],
                pos: <span class="number">0</span>,
            }
        }

        <span class="comment">// late bound: 声明和使用
        </span><span class="kw">fn </span>read_bytes&lt;<span class="lifetime">&#39;a</span>&gt;(<span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span><span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u8] {
            <span class="self">self</span>.pos += <span class="number">3</span>;
            <span class="kw-2">&amp;</span><span class="self">self</span>.buf[<span class="self">self</span>.pos - <span class="number">3</span>..<span class="self">self</span>.pos]
        }
    }

    <span class="kw">fn </span>print(b1: <span class="kw-2">&amp;</span>[u8], b2: <span class="kw-2">&amp;</span>[u8]) {
        <span class="macro">println!</span>(<span class="string">&quot;{:#?} {:#?}&quot;</span>, b1, b2);
    }


    <span class="kw">let </span><span class="kw-2">mut </span>buf = Buffer::new();
    <span class="kw">let </span>b1 = buf.read_bytes(); <span class="comment">// work

    // late bound 带来的后果
    // 编译器会检查重复可变引用

    //     let b2 = buf.read_bytes(); // 不能同时有两个借用
    //     let b3 = &amp;(buf.read_bytes().to_owned());
    //     print(b1,b2)


    // 案例 4.2 late bound 改写 early bound
    // early bound 提高了生命周期，本质上编译器检查的是两个变量
    // 所以并没有违反借用规则

    </span><span class="kw">struct </span>Buffer1&lt;<span class="lifetime">&#39;a</span>&gt; {
        buf: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u8],
        pos: usize,
    }

    <span class="kw">impl</span>&lt;<span class="lifetime">&#39;a</span>&gt; Buffer1&lt;<span class="lifetime">&#39;a</span>&gt; {

        <span class="kw">fn </span>new(b: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u8]) -&gt; Buffer1 {
            Buffer1 { buf: b, pos: <span class="number">0 </span>}
        }

        <span class="kw">fn </span>read_bytes(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u8] {
            <span class="self">self</span>.pos += <span class="number">3</span>;
            <span class="kw-2">&amp;</span><span class="self">self</span>.buf[<span class="self">self</span>.pos - <span class="number">3</span>..<span class="self">self</span>.pos]
        }
    }

    <span class="kw">let </span>v = <span class="macro">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];

    <span class="kw">let </span><span class="kw-2">mut </span>buf = Buffer1::new(<span class="kw-2">&amp;</span>v);
    <span class="kw">let </span>b1 = buf.read_bytes(); <span class="comment">// work
    </span><span class="kw">let </span>b2 = buf.read_bytes(); <span class="comment">//

    </span>print(b1, b2);

    <span class="comment">// 与如下同理
    </span><span class="kw">let </span><span class="kw-2">mut </span>s = String::from(<span class="string">&quot;hello&quot;</span>);
    <span class="kw">let </span>a = s.push_str(<span class="string">&quot; jian&quot;</span>);
    <span class="kw">let </span>b = s.push_str(<span class="string">&quot; quan&quot;</span>);</code></pre><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0A%20%20%20%20%2F%2F%20%E7%A4%BA%E4%BE%8B%202%20%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%E7%9A%84%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%0A%0A%20%20%20%20%2F%2F%20%E5%BD%93%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0%E9%83%BD%E6%98%AF%E5%80%9F%E7%94%A8%E7%B1%BB%E5%9E%8B%EF%BC%8C%E9%9C%80%E8%A6%81%E6%8C%87%E5%AE%9A%E8%BF%99%E4%BA%9B%E5%8F%82%E6%95%B0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%0A%20%20%20%20%2F%2F%20%E6%8C%87%E5%AE%9A%E8%A7%84%E5%88%99%3A%E5%85%A5%E5%8F%82%E5%A3%B0%E6%98%8E%E5%91%A8%E6%9C%9F%20%3E%3D%20%E8%BF%94%E5%9B%9E%E5%80%BC%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%0A%20%20%20%20%2F%2F%20'a%3A%20'c%20%E4%BB%A3%E8%A1%A8%20'a%20%3E%20'c%0A%0Afn%20main()%20%7B%0Afn%20the_longest%3C'c%2C%20'a%3A%20'c%3E(s1%3A%20%26'a%20str%2C%20s2%3A%20%26'a%20str)%20-%3E%20%26'c%20str%20%7B%0A%20%20%20%20%20%20%20%20if%20s1.len()%20%3E%20s2.len()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20s1%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20s2%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20let%20s1%20%3D%20String%3A%3Afrom(%22rust%22)%3B%0A%20%20%20%20let%20s1_r%20%3D%20%26s1%3B%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20let%20s2%20%3D%20String%3A%3Afrom(%22c%22)%3B%0A%20%20%20%20%20%20%20%20let%20res%20%3D%20the_longest(s1_r%2C%20%26s2)%3B%0A%20%20%20%20%20%20%20%20println!(%22%7B%3A%3F%7D%22%2C%20res)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20%E7%A4%BA%E4%BE%8B%203%20Rust%E5%A6%82%E4%BD%95%E8%AF%86%E5%88%AB%E5%B9%B6%E5%88%A4%E6%96%AD%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%E7%9A%84%EF%BC%9F%0A%0A%20%20%20%20%2F%2F%20Rust%20%E5%AE%9E%E9%99%85%E4%B8%8A%E4%BD%BF%E7%94%A8%E4%B8%A4%E5%A5%97%E8%A7%84%E5%88%99%EF%BC%9Aearly%20bound%20%E5%92%8C%20late%20bound%0A%20%20%20%20%2F%2F%20%E6%A0%B8%E5%BF%83%E6%98%AF%E5%8C%B9%E9%85%8D%E5%8F%82%E6%95%B0%E5%92%8C%E6%8C%87%E5%AE%9A%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%0A%0A%20%20%20%20%2F%2F%20%E7%A4%BA%E4%BE%8B%204%20early%20bound%20%E5%92%8C%20late%20bound%0A%0A%20%20%20%20%2F%2F%20%E5%85%88%E7%9C%8B%E7%9C%8B%E6%B3%9B%E5%9E%8B%E6%A1%88%E4%BE%8B%0A%20%20%20%20struct%20A%3CT%3E(T)%3B%0A%0A%20%20%20%20%2F%2F%20%E5%AE%9A%E4%B9%89%E6%97%B6%E4%B8%8D%E6%8C%87%E5%AE%9A%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E6%97%B6%E5%86%8D%E6%8C%87%E5%AE%9A%0A%20%20%20%20let%20a%20%3D%20A%3A%3A%3Ci32%3E(3)%3B%0A%20%20%20%20let%20b%20%3D%20A(%22string%22)%3B%0A%0A%0A%20%20%20%20%2F%2F%20early%20bound%20%E5%92%8C%20late%20bound%20%E5%8C%BA%E5%88%AB%0A%0A%20%20%20%20fn%20f%3C'a%3E()%20%7B%7D%20%2F%2F%20late%20bound%2C%E5%8F%AA%E5%A3%B0%E6%98%8E%EF%BC%8C%E4%B8%8D%E6%8C%87%E5%AE%9A%E3%80%82%0A%20%20%20%20fn%20g%3C'a%3A%20'a%3E()%20%7B%7D%20%2F%2F%20early%20bound%EF%BC%8C%E5%A3%B0%E6%98%8E%E4%B8%94%E6%8C%87%E5%AE%9A%0A%20%20%20%20fn%20h%3CT%3E()%20%7B%7D%0A%0A%20%20%20%20%2F%2Flet%20pf%20%3D%20f%3A%3A%3C'static%3E%20as%20fn()%3B%20%2F%2F%20late%20bound%20%E4%B8%8D%E8%83%BD%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A%EF%BC%8C%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E5%85%B7%E4%BD%93%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BE%8B%0A%20%20%20%20let%20pf%20%3D%20f()%3B%20%2F%2F%20late%20bound%20%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%EF%BC%8C%E4%B8%8D%E7%94%A8%E6%8C%87%E5%AE%9A%0A%0A%20%20%20%20%2F%2F%20%E5%A3%B0%E6%98%8E%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%E5%AE%9E%E9%99%85%E4%B8%8A%E6%98%AF%E6%B3%9B%E5%9E%8B%E7%9A%84%E4%B8%80%E7%A7%8D%0A%20%20%20%20let%20ph%20%3D%20h%3A%3A%3Ci32%3E()%3B%20%2F%2F%20%E6%99%AE%E9%80%9A%E6%B3%9B%E5%9E%8B%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%EF%BC%8C%E4%BC%9A%E5%9C%A8%E7%BC%96%E8%AF%91%E6%9C%9F%E5%8D%95%E6%80%81%E5%8C%96%0A%20%20%20%20let%20pg%20%3D%20g%3A%3A%3C'static%3E%20as%20fn()%3B%20%2F%2F%20early%20bound%20%E5%8F%AF%E4%BB%A5%E5%85%B7%E4%BD%93%E5%86%8D%E6%8C%87%E5%AE%9A%0A%0A%20%20%20%20%2F%2F%20%E6%A1%88%E4%BE%8B%204.1%20late%20bound%0A%0A%20%20%20%20struct%20Buffer%20%7B%0A%20%20%20%20%20%20%20%20buf%3A%20Vec%3Cu8%3E%2C%0A%20%20%20%20%20%20%20%20pos%3A%20usize%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20%E6%B2%A1%E6%9C%89%E5%9C%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E6%97%B6%E6%8C%87%E5%AE%9A%E5%9C%A8impl%E5%A4%84%0A%20%20%20%20%2F%2F%20%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BB%93%E6%9E%9C%E6%97%B6%E5%9C%A8%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E6%A3%80%E6%9F%A5local%20%E5%8F%98%E9%87%8F%0A%20%20%20%20%2F%2F%20%E4%BD%86%E6%98%AF%E4%BD%BF%E7%94%A8early%20bound%EF%BC%8C%E7%BC%96%E8%AF%91%E5%99%A8%E5%8F%AA%E4%BC%9A%E6%A3%80%E6%9F%A5%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E4%BB%A5%E5%8F%8A%E5%92%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%98%AF%E5%90%A6%E5%8C%B9%E9%85%8D%0A%0A%20%20%20%20impl%20Buffer%20%7B%0A%20%20%20%20%20%20%20%20fn%20new()%20-%3E%20Buffer%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20Buffer%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20buf%3A%20vec!%5B1%2C%202%2C%203%2C%204%2C%205%2C%206%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pos%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%2F%2F%20late%20bound%3A%20%E5%A3%B0%E6%98%8E%E5%92%8C%E4%BD%BF%E7%94%A8%0A%20%20%20%20%20%20%20%20fn%20read_bytes%3C'a%3E(%26'a%20mut%20self)%20-%3E%20%26'a%20%5Bu8%5D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20self.pos%20%2B%3D%203%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%26self.buf%5Bself.pos%20-%203..self.pos%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20fn%20print(b1%3A%20%26%5Bu8%5D%2C%20b2%3A%20%26%5Bu8%5D)%20%7B%0A%20%20%20%20%20%20%20%20println!(%22%7B%3A%23%3F%7D%20%7B%3A%23%3F%7D%22%2C%20b1%2C%20b2)%3B%0A%20%20%20%20%7D%0A%0A%0A%20%20%20%20let%20mut%20buf%20%3D%20Buffer%3A%3Anew()%3B%0A%20%20%20%20let%20b1%20%3D%20buf.read_bytes()%3B%20%2F%2F%20work%0A%0A%20%20%20%20%2F%2F%20late%20bound%20%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%90%8E%E6%9E%9C%0A%20%20%20%20%2F%2F%20%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E6%A3%80%E6%9F%A5%E9%87%8D%E5%A4%8D%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8%0A%0A%20%20%20%20%2F%2F%20%20%20%20%20let%20b2%20%3D%20buf.read_bytes()%3B%20%2F%2F%20%E4%B8%8D%E8%83%BD%E5%90%8C%E6%97%B6%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%80%9F%E7%94%A8%0A%20%20%20%20%2F%2F%20%20%20%20%20let%20b3%20%3D%20%26(buf.read_bytes().to_owned())%3B%0A%20%20%20%20%2F%2F%20%20%20%20%20print(b1%2Cb2)%0A%0A%0A%20%20%20%20%2F%2F%20%E6%A1%88%E4%BE%8B%204.2%20late%20bound%20%E6%94%B9%E5%86%99%20early%20bound%0A%20%20%20%20%2F%2F%20early%20bound%20%E6%8F%90%E9%AB%98%E4%BA%86%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E6%9C%AC%E8%B4%A8%E4%B8%8A%E7%BC%96%E8%AF%91%E5%99%A8%E6%A3%80%E6%9F%A5%E7%9A%84%E6%98%AF%E4%B8%A4%E4%B8%AA%E5%8F%98%E9%87%8F%0A%20%20%20%20%2F%2F%20%E6%89%80%E4%BB%A5%E5%B9%B6%E6%B2%A1%E6%9C%89%E8%BF%9D%E5%8F%8D%E5%80%9F%E7%94%A8%E8%A7%84%E5%88%99%0A%0A%20%20%20%20struct%20Buffer1%3C'a%3E%20%7B%0A%20%20%20%20%20%20%20%20buf%3A%20%26'a%20%5Bu8%5D%2C%0A%20%20%20%20%20%20%20%20pos%3A%20usize%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20impl%3C'a%3E%20Buffer1%3C'a%3E%20%7B%0A%0A%20%20%20%20%20%20%20%20fn%20new(b%3A%20%26'a%20%5Bu8%5D)%20-%3E%20Buffer1%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20Buffer1%20%7B%20buf%3A%20b%2C%20pos%3A%200%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20fn%20read_bytes(%26mut%20self)%20-%3E%20%26'a%20%5Bu8%5D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20self.pos%20%2B%3D%203%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%26self.buf%5Bself.pos%20-%203..self.pos%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20let%20v%20%3D%20vec!%5B1%2C%202%2C%203%2C%204%2C%205%2C%206%5D%3B%0A%0A%20%20%20%20let%20mut%20buf%20%3D%20Buffer1%3A%3Anew(%26v)%3B%0A%20%20%20%20let%20b1%20%3D%20buf.read_bytes()%3B%20%2F%2F%20work%0A%20%20%20%20let%20b2%20%3D%20buf.read_bytes()%3B%20%2F%2F%0A%0A%20%20%20%20print(b1%2C%20b2)%3B%0A%0A%20%20%20%20%2F%2F%20%E4%B8%8E%E5%A6%82%E4%B8%8B%E5%90%8C%E7%90%86%0A%20%20%20%20let%20mut%20s%20%3D%20String%3A%3Afrom(%22hello%22)%3B%0A%20%20%20%20let%20a%20%3D%20s.push_str(%22%20jian%22)%3B%0A%20%20%20%20let%20b%20%3D%20s.push_str(%22%20quan%22)%3B%0A%7D&amp;edition=2021">Run</a></div>
<h4 id="t和t"><a href="#t和t">&amp;T和T</a></h4>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code> <span class="kw">trait </span>Trait {
       <span class="kw">fn </span>f(<span class="self">self</span>);
   }
   <span class="kw">impl</span>&lt;T&gt; Trait <span class="kw">for fn</span>(T) { <span class="comment">// 此处的T指值或者引用
       </span><span class="kw">fn </span>f(<span class="self">self</span>) {
           <span class="macro">print!</span>(<span class="string">&quot;1&quot;</span>)
       }
   }
   <span class="kw">impl</span>&lt;T&gt; Trait <span class="kw">for fn</span>(<span class="kw-2">&amp;</span>T) { <span class="comment">// &amp;T 指引用
       </span><span class="kw">fn </span>f(<span class="self">self</span>) {
           <span class="macro">print!</span>(<span class="string">&quot;2&quot;</span>)
       }
   }

   <span class="kw">let </span>a: <span class="kw">fn</span>(<span class="kw">_</span>) = |<span class="kw">_</span>: u8| {};
   <span class="kw">let </span>b: <span class="kw">fn</span>(<span class="kw">_</span>) = |<span class="kw">_</span>: <span class="kw-2">&amp;</span>u8| {};
   <span class="kw">let </span>c: <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="kw">_</span>) = |<span class="kw">_</span>: <span class="kw-2">&amp;</span>u8| {}; <span class="comment">//实例化

   // 编译器会根据地函数参数以及制定的类型来调用
   </span>a.f(); <span class="comment">// 1
   </span>b.f(); <span class="comment">// 1
   </span>c.f(); <span class="comment">// 2

   // T 与 &amp;T，后者是前者的子集
   // 但是可以为后者实现特殊的方法重载
   </span><span class="kw">trait </span>Trait {
       <span class="kw">fn </span>f(<span class="self">self</span>);
   }
   <span class="kw">impl</span>&lt;T&gt; Trait <span class="kw">for fn</span>(T) {
       <span class="kw">fn </span>f(<span class="self">self</span>) {
           <span class="macro">print!</span>(<span class="string">&quot;1&quot;</span>)
       }
   }

   <span class="comment">//     impl&lt;&#39;a,T&gt; Trait for fn(&amp;&#39;a T) {
   </span><span class="kw">impl</span>&lt;T&gt; Trait <span class="kw">for fn</span>(<span class="kw-2">&amp;</span>T) {
       <span class="comment">// 此处会生命和使用默认的生命周期参数，不可以手动显式声明
       // 因为参数是引用类型
       </span><span class="kw">fn </span>f(<span class="self">self</span>) {
           <span class="macro">print!</span>(<span class="string">&quot;2&quot;</span>)
       }
   }

   <span class="kw">let </span>a: <span class="kw">fn</span>(<span class="kw">_</span>) = |<span class="kw">_</span>: u8| {};
   <span class="kw">let </span>b: <span class="kw">fn</span>(<span class="kw">_</span>) = |<span class="kw">_</span>: <span class="kw-2">&amp;</span>u8| {}; <span class="comment">// 编译器会为参数默认加上生命周期参数x，同 &amp;&#39;x u8
   </span><span class="kw">let </span>c: <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="kw">_</span>) = |<span class="kw">_</span>: <span class="kw-2">&amp;</span>u8| {}; <span class="comment">//在此处会实例化，也是一个late bound的case

   </span>a.f(); <span class="comment">// 1
   </span>b.f(); <span class="comment">// 1
   </span>c.f(); <span class="comment">// 2

   // early bound 还体现在函数第二个（第n个）参数的调用上
   //case 2

   </span><span class="kw">use </span>std::collections::HashSet;
   <span class="kw">let </span>hello = <span class="string">&quot;hello&quot;</span>.to_owned();
   <span class="kw">let </span><span class="kw-2">mut </span>items: HashSet&lt;<span class="kw-2">&amp;</span>str&gt; = HashSet::new();

   items.insert(hello.as_str());

   <span class="kw">let </span><span class="kw-2">mut </span>global_set: HashSet&lt;<span class="kw-2">&amp;</span>str&gt; = HashSet::new();
   global_set.insert(hello.as_str());

   <span class="kw">while </span>!global_set.is_empty() {
       <span class="kw">let </span><span class="kw-2">mut </span>temp_set: HashSet&lt;<span class="kw-2">&amp;</span>str&gt; = HashSet::new();

       <span class="kw">for </span><span class="kw-2">&amp;</span>item <span class="kw">in </span>global_set.iter() {
           <span class="kw">let </span>copy = item.to_owned();
           <span class="kw">let </span>copy_str = copy.as_str(); <span class="comment">// &amp;self

           // 此处不能使用get(&amp;copy_str),如果再借用一次，当离开copy的作用域时，仍然使用
           // 再借用就判断符合上下文
           // 不加编译器只会判断get函数
           </span><span class="kw">if let </span><span class="prelude-val">Some</span>(inner) = items.get(copy_str).cloned() {
               temp_set.insert(inner);
           }
       }

       std::mem::swap(<span class="kw-2">&amp;mut </span>global_set, <span class="kw-2">&amp;mut </span>temp_set);
       <span class="kw">break</span>;
   }</code></pre><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0Afn%20main()%20%7B%0Atrait%20Trait%20%7B%0A%20%20%20%20%20%20%20fn%20f(self)%3B%0A%20%20%20%7D%0A%20%20%20impl%3CT%3E%20Trait%20for%20fn(T)%20%7B%20%2F%2F%20%E6%AD%A4%E5%A4%84%E7%9A%84T%E6%8C%87%E5%80%BC%E6%88%96%E8%80%85%E5%BC%95%E7%94%A8%0A%20%20%20%20%20%20%20fn%20f(self)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20print!(%221%22)%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%20%20%20impl%3CT%3E%20Trait%20for%20fn(%26T)%20%7B%20%2F%2F%20%26T%20%E6%8C%87%E5%BC%95%E7%94%A8%0A%20%20%20%20%20%20%20fn%20f(self)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20print!(%222%22)%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20let%20a%3A%20fn(_)%20%3D%20%7C_%3A%20u8%7C%20%7B%7D%3B%0A%20%20%20let%20b%3A%20fn(_)%20%3D%20%7C_%3A%20%26u8%7C%20%7B%7D%3B%0A%20%20%20let%20c%3A%20fn(%26_)%20%3D%20%7C_%3A%20%26u8%7C%20%7B%7D%3B%20%2F%2F%E5%AE%9E%E4%BE%8B%E5%8C%96%0A%0A%20%20%20%2F%2F%20%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E6%A0%B9%E6%8D%AE%E5%9C%B0%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E4%BB%A5%E5%8F%8A%E5%88%B6%E5%AE%9A%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%9D%A5%E8%B0%83%E7%94%A8%0A%20%20%20a.f()%3B%20%2F%2F%201%0A%20%20%20b.f()%3B%20%2F%2F%201%0A%20%20%20c.f()%3B%20%2F%2F%202%0A%0A%20%20%20%2F%2F%20T%20%E4%B8%8E%20%26T%EF%BC%8C%E5%90%8E%E8%80%85%E6%98%AF%E5%89%8D%E8%80%85%E7%9A%84%E5%AD%90%E9%9B%86%0A%20%20%20%2F%2F%20%E4%BD%86%E6%98%AF%E5%8F%AF%E4%BB%A5%E4%B8%BA%E5%90%8E%E8%80%85%E5%AE%9E%E7%8E%B0%E7%89%B9%E6%AE%8A%E7%9A%84%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD%0A%20%20%20trait%20Trait%20%7B%0A%20%20%20%20%20%20%20fn%20f(self)%3B%0A%20%20%20%7D%0A%20%20%20impl%3CT%3E%20Trait%20for%20fn(T)%20%7B%0A%20%20%20%20%20%20%20fn%20f(self)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20print!(%221%22)%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20%2F%2F%20%20%20%20%20impl%3C'a%2CT%3E%20Trait%20for%20fn(%26'a%20T)%20%7B%0A%20%20%20impl%3CT%3E%20Trait%20for%20fn(%26T)%20%7B%0A%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A4%E5%A4%84%E4%BC%9A%E7%94%9F%E5%91%BD%E5%92%8C%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%EF%BC%8C%E4%B8%8D%E5%8F%AF%E4%BB%A5%E6%89%8B%E5%8A%A8%E6%98%BE%E5%BC%8F%E5%A3%B0%E6%98%8E%0A%20%20%20%20%20%20%20%2F%2F%20%E5%9B%A0%E4%B8%BA%E5%8F%82%E6%95%B0%E6%98%AF%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%0A%20%20%20%20%20%20%20fn%20f(self)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20print!(%222%22)%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20let%20a%3A%20fn(_)%20%3D%20%7C_%3A%20u8%7C%20%7B%7D%3B%0A%20%20%20let%20b%3A%20fn(_)%20%3D%20%7C_%3A%20%26u8%7C%20%7B%7D%3B%20%2F%2F%20%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E4%B8%BA%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%8A%A0%E4%B8%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0x%EF%BC%8C%E5%90%8C%20%26'x%20u8%0A%20%20%20let%20c%3A%20fn(%26_)%20%3D%20%7C_%3A%20%26u8%7C%20%7B%7D%3B%20%2F%2F%E5%9C%A8%E6%AD%A4%E5%A4%84%E4%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%EF%BC%8C%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AAlate%20bound%E7%9A%84case%0A%0A%20%20%20a.f()%3B%20%2F%2F%201%0A%20%20%20b.f()%3B%20%2F%2F%201%0A%20%20%20c.f()%3B%20%2F%2F%202%0A%0A%20%20%20%2F%2F%20early%20bound%20%E8%BF%98%E4%BD%93%E7%8E%B0%E5%9C%A8%E5%87%BD%E6%95%B0%E7%AC%AC%E4%BA%8C%E4%B8%AA%EF%BC%88%E7%AC%ACn%E4%B8%AA%EF%BC%89%E5%8F%82%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E4%B8%8A%0A%20%20%20%2F%2Fcase%202%0A%0A%20%20%20use%20std%3A%3Acollections%3A%3AHashSet%3B%0A%20%20%20let%20hello%20%3D%20%22hello%22.to_owned()%3B%0A%20%20%20let%20mut%20items%3A%20HashSet%3C%26str%3E%20%3D%20HashSet%3A%3Anew()%3B%0A%0A%20%20%20items.insert(hello.as_str())%3B%0A%0A%20%20%20let%20mut%20global_set%3A%20HashSet%3C%26str%3E%20%3D%20HashSet%3A%3Anew()%3B%0A%20%20%20global_set.insert(hello.as_str())%3B%0A%0A%20%20%20while%20!global_set.is_empty()%20%7B%0A%20%20%20%20%20%20%20let%20mut%20temp_set%3A%20HashSet%3C%26str%3E%20%3D%20HashSet%3A%3Anew()%3B%0A%0A%20%20%20%20%20%20%20for%20%26item%20in%20global_set.iter()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20let%20copy%20%3D%20item.to_owned()%3B%0A%20%20%20%20%20%20%20%20%20%20%20let%20copy_str%20%3D%20copy.as_str()%3B%20%2F%2F%20%26self%0A%0A%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A4%E5%A4%84%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8get(%26copy_str)%2C%E5%A6%82%E6%9E%9C%E5%86%8D%E5%80%9F%E7%94%A8%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%BD%93%E7%A6%BB%E5%BC%80copy%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%97%B6%EF%BC%8C%E4%BB%8D%E7%84%B6%E4%BD%BF%E7%94%A8%0A%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%86%8D%E5%80%9F%E7%94%A8%E5%B0%B1%E5%88%A4%E6%96%AD%E7%AC%A6%E5%90%88%E4%B8%8A%E4%B8%8B%E6%96%87%0A%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%8D%E5%8A%A0%E7%BC%96%E8%AF%91%E5%99%A8%E5%8F%AA%E4%BC%9A%E5%88%A4%E6%96%ADget%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20%20%20%20if%20let%20Some(inner)%20%3D%20items.get(copy_str).cloned()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp_set.insert(inner)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20std%3A%3Amem%3A%3Aswap(%26mut%20global_set%2C%20%26mut%20temp_set)%3B%0A%20%20%20%20%20%20%20break%3B%0A%20%20%20%7D%0A%7D&amp;edition=2021">Run</a></div>
<h4 id="trait-对象的生命周期参数"><a href="#trait-对象的生命周期参数">trait 对象的生命周期参数</a></h4>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">struct </span>FooImpl&lt;<span class="lifetime">&#39;a</span>&gt; {
       s: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u32],
   }
   <span class="kw">impl</span>&lt;<span class="lifetime">&#39;a</span>&gt; Foo&lt;<span class="lifetime">&#39;a</span>&gt; <span class="kw">for </span>FooImpl&lt;<span class="lifetime">&#39;a</span>&gt; {}

   <span class="comment">// trait 对象必须使用 Box包裹
   // 任何实现了 某个trait的类型，它的实例都是 trait对象
   // trait 对象默认为静态生命周期，当作为返回值时，需要手动“缩短”（指定生命周期参数，如‘a）

   // fn foo&lt;&#39;a, &#39;b: &#39;a&gt;(s: &amp;&#39;a [u32]) -&gt; Box&lt;dyn Foo&lt;&#39;a&gt; + &#39;a&gt; { //第一种写法
   </span><span class="kw">fn </span>foo&lt;<span class="lifetime">&#39;a</span>&gt;(s: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>[u32]) -&gt; Box&lt;<span class="kw">dyn </span>Foo&lt;<span class="lifetime">&#39;a</span>&gt; + <span class="lifetime">&#39;a</span>&gt; {
       <span class="comment">// 第二种写法
       </span>Box::new(FooImpl { s: s })
   }
</code></pre><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0Afn%20main()%20%7B%0Astruct%20FooImpl%3C'a%3E%20%7B%0A%20%20%20%20%20%20%20s%3A%20%26'a%20%5Bu32%5D%2C%0A%20%20%20%7D%0A%20%20%20impl%3C'a%3E%20Foo%3C'a%3E%20for%20FooImpl%3C'a%3E%20%7B%7D%0A%0A%20%20%20%2F%2F%20trait%20%E5%AF%B9%E8%B1%A1%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8%20Box%E5%8C%85%E8%A3%B9%0A%20%20%20%2F%2F%20%E4%BB%BB%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BA%86%20%E6%9F%90%E4%B8%AAtrait%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%AE%83%E7%9A%84%E5%AE%9E%E4%BE%8B%E9%83%BD%E6%98%AF%20trait%E5%AF%B9%E8%B1%A1%0A%20%20%20%2F%2F%20trait%20%E5%AF%B9%E8%B1%A1%E9%BB%98%E8%AE%A4%E4%B8%BA%E9%9D%99%E6%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E5%BD%93%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E2%80%9C%E7%BC%A9%E7%9F%AD%E2%80%9D%EF%BC%88%E6%8C%87%E5%AE%9A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%EF%BC%8C%E5%A6%82%E2%80%98a%EF%BC%89%0A%0A%20%20%20%2F%2F%20fn%20foo%3C'a%2C%20'b%3A%20'a%3E(s%3A%20%26'a%20%5Bu32%5D)%20-%3E%20Box%3Cdyn%20Foo%3C'a%3E%20%2B%20'a%3E%20%7B%20%2F%2F%E7%AC%AC%E4%B8%80%E7%A7%8D%E5%86%99%E6%B3%95%0A%20%20%20fn%20foo%3C'a%3E(s%3A%20%26'a%20%5Bu32%5D)%20-%3E%20Box%3Cdyn%20Foo%3C'a%3E%20%2B%20'a%3E%20%7B%0A%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E7%A7%8D%E5%86%99%E6%B3%95%0A%20%20%20%20%20%20%20Box%3A%3Anew(FooImpl%20%7B%20s%3A%20s%20%7D)%0A%20%20%20%7D%0A%7D&amp;edition=2021">Run</a></div>
<h4 id="高阶生命周期参数"><a href="#高阶生命周期参数">高阶生命周期参数</a></h4>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code>   <span class="comment">// 1.使用高阶生命参数 for语法
   </span><span class="kw">use </span>std::fmt::Debug;
   <span class="kw">trait </span>DosSomething&lt;T&gt; {
       <span class="kw">fn </span>do_something(<span class="kw-2">&amp;</span><span class="self">self</span>, value: T);
   }

   <span class="kw">impl</span>&lt;<span class="lifetime">&#39;a</span>, T: Debug&gt; DosSomething&lt;T&gt; <span class="kw">for </span><span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>usize {
       <span class="kw">fn </span>do_something(<span class="kw-2">&amp;</span><span class="self">self</span>, value: T) {
           <span class="macro">println!</span>(<span class="string">&quot;{:?}&quot;</span>, value);
       }
   }

   <span class="comment">// 高阶生命周期，高阶限定，for语法，是一种late bound
   //     fn foo&lt;&#39;a&gt;(b: Box&lt;dyn DosSomething&lt;&amp;&#39;a usize&gt;&gt;) { 改动前
   </span><span class="kw">fn </span>foo&lt;<span class="lifetime">&#39;a</span>&gt;(b: Box&lt;<span class="kw">dyn for</span>&lt;<span class="lifetime">&#39;f</span>&gt; DosSomething&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;f </span>usize&gt;&gt;) {
       <span class="comment">// 不在当前作用域判断
       </span><span class="kw">let </span>s: usize = <span class="number">10</span>;
       b.do_something(<span class="kw-2">&amp;</span>s) <span class="comment">// 在do something 函数作用域判断
   </span>}

   <span class="kw">let </span>x = Box::new(<span class="kw-2">&amp;</span><span class="number">2usize</span>);
   foo(x)

   <span class="comment">// 2.高阶生命参数在闭包中的用法

   // 不能通过高阶语法来修复
   // let f = |x: &amp;i32| x;
   // 如：
   // let f: for&lt;&#39;a&gt; Fn(&amp;&#39;a i32) -&gt; &amp;&#39;a i32 = |x| x;
   // fn foo&lt;&#39;a&gt;(b: Box&lt;dyn for&lt;&#39;f&gt; DosSomething&lt;&amp;&#39;f usize&gt;&gt;) {

   // 修复方法 1：通过外部函数 late bound
   // 函数返回F,F为实现了 Fn trait的闭包，并且是late bound
   </span><span class="kw">fn </span>annotate1&lt;T, F&gt;(f: F) -&gt; F
   <span class="kw">where
       for</span>&lt;<span class="lifetime">&#39;a</span>&gt; F: Fn(<span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>T) -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>T,
   {
       f
   }

   <span class="comment">// 修复方法2：通过外部函数 early bound
   </span><span class="kw">fn </span>annotate2&lt;<span class="lifetime">&#39;a</span>, T: <span class="lifetime">&#39;a</span>, F&gt;(f: F) -&gt; F
   <span class="kw">where
       </span>F: Fn(<span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>T) -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>T,
   {
       f
   }

   <span class="comment">// 不管怎么样，都是告诉编译器该怎么判断

   </span><span class="kw">let </span>f = annotate1(|x: <span class="kw-2">&amp;</span>i32| x);
   <span class="kw">let </span>f = annotate2(|x: <span class="kw-2">&amp;</span>i32| x);
   <span class="kw">let </span>i = <span class="kw-2">&amp;</span><span class="number">3</span>;
   <span class="kw">let </span>j = f(i); <span class="comment">// 本身是为了使用这个闭包，在这里才会检查x

   // 3.高阶生命周期参数 trait应用

   // trait 对象高阶生命参数 for 在多态调用中的应用
   </span><span class="kw">use </span>rand;
   <span class="kw">use </span>std::io::Read;

   <span class="kw">trait </span>CheckSum&lt;R: Read&gt; {
       <span class="kw">fn </span>calc(<span class="kw-2">&amp;mut </span><span class="self">self</span>, r: R) -&gt; Vec&lt;u8&gt;;
   }

   <span class="kw">struct </span>Xor;

   <span class="kw">impl</span>&lt;R: Read&gt; CheckSum&lt;R&gt; <span class="kw">for </span>Xor {
       <span class="kw">fn </span>calc(<span class="kw-2">&amp;mut </span><span class="self">self</span>, <span class="kw-2">mut </span>r: R) -&gt; Vec&lt;u8&gt; {
           <span class="kw">let </span><span class="kw-2">mut </span>res: u8 = <span class="number">0</span>;
           <span class="kw">let </span><span class="kw-2">mut </span>buf = [<span class="number">0u8</span>; <span class="number">8</span>];

           <span class="kw">loop </span>{
               <span class="kw">let </span>read = r.read(<span class="kw-2">&amp;mut </span>buf).unwrap();
               <span class="kw">if </span>read == <span class="number">0 </span>{
                   <span class="kw">break</span>;
               }

               <span class="kw">for </span>b <span class="kw">in </span><span class="kw-2">&amp;</span>buf[..read] {
                   res ^= b;
               }
           }
           <span class="macro">vec!</span>[res]
       }
   }

   <span class="kw">struct </span>Add;

   <span class="kw">impl</span>&lt;R: Read&gt; CheckSum&lt;R&gt; <span class="kw">for </span>Add {
       <span class="kw">fn </span>calc(<span class="kw-2">&amp;mut </span><span class="self">self</span>, <span class="kw-2">mut </span>r: R) -&gt; Vec&lt;u8&gt; {
           <span class="kw">let </span><span class="kw-2">mut </span>res: u8 = <span class="number">0</span>;
           <span class="kw">let </span><span class="kw-2">mut </span>buf = [<span class="number">0u8</span>; <span class="number">8</span>];

           <span class="kw">loop </span>{
               <span class="kw">let </span>read = r.read(<span class="kw-2">&amp;mut </span>buf).unwrap();
               <span class="kw">if </span>read == <span class="number">0 </span>{
                   <span class="kw">break</span>;
               }
               <span class="comment">// late bound
               </span><span class="kw">for </span>b <span class="kw">in </span><span class="kw-2">&amp;</span>buf[..read] {
                   <span class="kw">let </span>tmp = res <span class="kw">as </span>u16 + <span class="kw-2">*</span>b <span class="kw">as </span>u16;
                   res = tmp <span class="kw">as </span>u8;
               }
           }
           <span class="macro">vec!</span>[res]
       }
   }

   <span class="kw">let </span><span class="kw-2">mut </span>buf = [<span class="number">0u8</span>; <span class="number">128</span>];

   <span class="comment">// late bound
   </span><span class="kw">let </span><span class="kw-2">mut </span>checker: Box&lt;<span class="kw">dyn for</span>&lt;<span class="lifetime">&#39;f</span>&gt; CheckSum&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;f </span>[u8]&gt;&gt; = <span class="kw">if </span>rand::random() {
       <span class="macro">println!</span>(<span class="string">&quot;Initializing Xor Checksum&quot;</span>);
       Box::new(Xor)
   } <span class="kw">else </span>{
       <span class="macro">println!</span>(<span class="string">&quot;Initializing Add Checksum&quot;</span>);
       Box::new(Add)
   };

   <span class="kw">let </span><span class="kw-2">mut </span>data = <span class="string">&quot;data.read(&amp;mut buf).unwrap()&quot;</span>.as_bytes();
   <span class="kw">let </span><span class="kw-2">mut </span>i = <span class="number">0</span>;

   <span class="kw">loop </span>{
       <span class="kw">let </span>chunk_size = data.read(<span class="kw-2">&amp;mut </span>buf).unwrap();
       <span class="kw">if </span>chunk_size == <span class="number">0 </span>{
           <span class="kw">break</span>;
       }
       <span class="kw">let </span>cs = checker.calc(<span class="kw-2">&amp;</span>buf[..chunk_size]);
       <span class="macro">println!</span>(<span class="string">&quot;CheckSum {} is {:?}&quot;</span>, i, cs);
       i += <span class="number">1</span>;
   }
</code></pre><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Ballow(unused)%5D%0A%20%20%20%2F%2F%201.%E4%BD%BF%E7%94%A8%E9%AB%98%E9%98%B6%E7%94%9F%E5%91%BD%E5%8F%82%E6%95%B0%20for%E8%AF%AD%E6%B3%95%0Afn%20main()%20%7B%0Ause%20std%3A%3Afmt%3A%3ADebug%3B%0A%20%20%20trait%20DosSomething%3CT%3E%20%7B%0A%20%20%20%20%20%20%20fn%20do_something(%26self%2C%20value%3A%20T)%3B%0A%20%20%20%7D%0A%0A%20%20%20impl%3C'a%2C%20T%3A%20Debug%3E%20DosSomething%3CT%3E%20for%20%26'a%20usize%20%7B%0A%20%20%20%20%20%20%20fn%20do_something(%26self%2C%20value%3A%20T)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20println!(%22%7B%3A%3F%7D%22%2C%20value)%3B%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20%2F%2F%20%E9%AB%98%E9%98%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E9%AB%98%E9%98%B6%E9%99%90%E5%AE%9A%EF%BC%8Cfor%E8%AF%AD%E6%B3%95%EF%BC%8C%E6%98%AF%E4%B8%80%E7%A7%8Dlate%20bound%0A%20%20%20%2F%2F%20%20%20%20%20fn%20foo%3C'a%3E(b%3A%20Box%3Cdyn%20DosSomething%3C%26'a%20usize%3E%3E)%20%7B%20%E6%94%B9%E5%8A%A8%E5%89%8D%0A%20%20%20fn%20foo%3C'a%3E(b%3A%20Box%3Cdyn%20for%3C'f%3E%20DosSomething%3C%26'f%20usize%3E%3E)%20%7B%0A%20%20%20%20%20%20%20%2F%2F%20%E4%B8%8D%E5%9C%A8%E5%BD%93%E5%89%8D%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%88%A4%E6%96%AD%0A%20%20%20%20%20%20%20let%20s%3A%20usize%20%3D%2010%3B%0A%20%20%20%20%20%20%20b.do_something(%26s)%20%2F%2F%20%E5%9C%A8do%20something%20%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%88%A4%E6%96%AD%0A%20%20%20%7D%0A%0A%20%20%20let%20x%20%3D%20Box%3A%3Anew(%262usize)%3B%0A%20%20%20foo(x)%0A%0A%20%20%20%2F%2F%202.%E9%AB%98%E9%98%B6%E7%94%9F%E5%91%BD%E5%8F%82%E6%95%B0%E5%9C%A8%E9%97%AD%E5%8C%85%E4%B8%AD%E7%9A%84%E7%94%A8%E6%B3%95%0A%0A%20%20%20%2F%2F%20%E4%B8%8D%E8%83%BD%E9%80%9A%E8%BF%87%E9%AB%98%E9%98%B6%E8%AF%AD%E6%B3%95%E6%9D%A5%E4%BF%AE%E5%A4%8D%0A%20%20%20%2F%2F%20let%20f%20%3D%20%7Cx%3A%20%26i32%7C%20x%3B%0A%20%20%20%2F%2F%20%E5%A6%82%EF%BC%9A%0A%20%20%20%2F%2F%20let%20f%3A%20for%3C'a%3E%20Fn(%26'a%20i32)%20-%3E%20%26'a%20i32%20%3D%20%7Cx%7C%20x%3B%0A%20%20%20%2F%2F%20fn%20foo%3C'a%3E(b%3A%20Box%3Cdyn%20for%3C'f%3E%20DosSomething%3C%26'f%20usize%3E%3E)%20%7B%0A%0A%20%20%20%2F%2F%20%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95%201%EF%BC%9A%E9%80%9A%E8%BF%87%E5%A4%96%E9%83%A8%E5%87%BD%E6%95%B0%20late%20bound%0A%20%20%20%2F%2F%20%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9EF%2CF%E4%B8%BA%E5%AE%9E%E7%8E%B0%E4%BA%86%20Fn%20trait%E7%9A%84%E9%97%AD%E5%8C%85%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%98%AFlate%20bound%0A%20%20%20fn%20annotate1%3CT%2C%20F%3E(f%3A%20F)%20-%3E%20F%0A%20%20%20where%0A%20%20%20%20%20%20%20for%3C'a%3E%20F%3A%20Fn(%26'a%20T)%20-%3E%20%26'a%20T%2C%0A%20%20%20%7B%0A%20%20%20%20%20%20%20f%0A%20%20%20%7D%0A%0A%20%20%20%2F%2F%20%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%952%EF%BC%9A%E9%80%9A%E8%BF%87%E5%A4%96%E9%83%A8%E5%87%BD%E6%95%B0%20early%20bound%0A%20%20%20fn%20annotate2%3C'a%2C%20T%3A%20'a%2C%20F%3E(f%3A%20F)%20-%3E%20F%0A%20%20%20where%0A%20%20%20%20%20%20%20F%3A%20Fn(%26'a%20T)%20-%3E%20%26'a%20T%2C%0A%20%20%20%7B%0A%20%20%20%20%20%20%20f%0A%20%20%20%7D%0A%0A%20%20%20%2F%2F%20%E4%B8%8D%E7%AE%A1%E6%80%8E%E4%B9%88%E6%A0%B7%EF%BC%8C%E9%83%BD%E6%98%AF%E5%91%8A%E8%AF%89%E7%BC%96%E8%AF%91%E5%99%A8%E8%AF%A5%E6%80%8E%E4%B9%88%E5%88%A4%E6%96%AD%0A%0A%20%20%20let%20f%20%3D%20annotate1(%7Cx%3A%20%26i32%7C%20x)%3B%0A%20%20%20let%20f%20%3D%20annotate2(%7Cx%3A%20%26i32%7C%20x)%3B%0A%20%20%20let%20i%20%3D%20%263%3B%0A%20%20%20let%20j%20%3D%20f(i)%3B%20%2F%2F%20%E6%9C%AC%E8%BA%AB%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E9%97%AD%E5%8C%85%EF%BC%8C%E5%9C%A8%E8%BF%99%E9%87%8C%E6%89%8D%E4%BC%9A%E6%A3%80%E6%9F%A5x%0A%0A%20%20%20%2F%2F%203.%E9%AB%98%E9%98%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%82%E6%95%B0%20trait%E5%BA%94%E7%94%A8%0A%0A%20%20%20%2F%2F%20trait%20%E5%AF%B9%E8%B1%A1%E9%AB%98%E9%98%B6%E7%94%9F%E5%91%BD%E5%8F%82%E6%95%B0%20for%20%E5%9C%A8%E5%A4%9A%E6%80%81%E8%B0%83%E7%94%A8%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%0A%20%20%20use%20rand%3B%0A%20%20%20use%20std%3A%3Aio%3A%3ARead%3B%0A%0A%20%20%20trait%20CheckSum%3CR%3A%20Read%3E%20%7B%0A%20%20%20%20%20%20%20fn%20calc(%26mut%20self%2C%20r%3A%20R)%20-%3E%20Vec%3Cu8%3E%3B%0A%20%20%20%7D%0A%0A%20%20%20struct%20Xor%3B%0A%0A%20%20%20impl%3CR%3A%20Read%3E%20CheckSum%3CR%3E%20for%20Xor%20%7B%0A%20%20%20%20%20%20%20fn%20calc(%26mut%20self%2C%20mut%20r%3A%20R)%20-%3E%20Vec%3Cu8%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20let%20mut%20res%3A%20u8%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20let%20mut%20buf%20%3D%20%5B0u8%3B%208%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20loop%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20read%20%3D%20r.read(%26mut%20buf).unwrap()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20read%20%3D%3D%200%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20b%20in%20%26buf%5B..read%5D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20res%20%5E%3D%20b%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20vec!%5Bres%5D%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20struct%20Add%3B%0A%0A%20%20%20impl%3CR%3A%20Read%3E%20CheckSum%3CR%3E%20for%20Add%20%7B%0A%20%20%20%20%20%20%20fn%20calc(%26mut%20self%2C%20mut%20r%3A%20R)%20-%3E%20Vec%3Cu8%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20let%20mut%20res%3A%20u8%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20let%20mut%20buf%20%3D%20%5B0u8%3B%208%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20loop%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20read%20%3D%20r.read(%26mut%20buf).unwrap()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20read%20%3D%3D%200%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20late%20bound%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20b%20in%20%26buf%5B..read%5D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20tmp%20%3D%20res%20as%20u16%20%2B%20*b%20as%20u16%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20res%20%3D%20tmp%20as%20u8%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20vec!%5Bres%5D%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%7D%0A%0A%20%20%20let%20mut%20buf%20%3D%20%5B0u8%3B%20128%5D%3B%0A%0A%20%20%20%2F%2F%20late%20bound%0A%20%20%20let%20mut%20checker%3A%20Box%3Cdyn%20for%3C'f%3E%20CheckSum%3C%26'f%20%5Bu8%5D%3E%3E%20%3D%20if%20rand%3A%3Arandom()%20%7B%0A%20%20%20%20%20%20%20println!(%22Initializing%20Xor%20Checksum%22)%3B%0A%20%20%20%20%20%20%20Box%3A%3Anew(Xor)%0A%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20println!(%22Initializing%20Add%20Checksum%22)%3B%0A%20%20%20%20%20%20%20Box%3A%3Anew(Add)%0A%20%20%20%7D%3B%0A%0A%20%20%20let%20mut%20data%20%3D%20%22data.read(%26mut%20buf).unwrap()%22.as_bytes()%3B%0A%20%20%20let%20mut%20i%20%3D%200%3B%0A%0A%20%20%20loop%20%7B%0A%20%20%20%20%20%20%20let%20chunk_size%20%3D%20data.read(%26mut%20buf).unwrap()%3B%0A%20%20%20%20%20%20%20if%20chunk_size%20%3D%3D%200%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20let%20cs%20%3D%20checker.calc(%26buf%5B..chunk_size%5D)%3B%0A%20%20%20%20%20%20%20println!(%22CheckSum%20%7B%7D%20is%20%7B%3A%3F%7D%22%2C%20i%2C%20cs)%3B%0A%20%20%20%20%20%20%20i%20%2B%3D%201%3B%0A%20%20%20%7D%0A%7D&amp;edition=2021">Run</a></div>
</div></details></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="from_principle_to_practice" data-themes="" data-resource-suffix="" data-rustdoc-version="1.67.0-nightly (c5d82ed7a 2022-11-19)" data-search-js="search-df80cc3cb87b6482.js" data-settings-js="settings-7e1cf5cc683233f7.js" data-settings-css="settings-af96d9e2fc13e081.css" ></div></body></html>